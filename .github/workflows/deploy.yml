name: Build & Deploy to GKE (Latest + Commit Tag)

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: sound-jigsaw-465314-s6      # GCP Project ID
      CLUSTER_NAME: gcr-gke-cluster           # GKE Cluster Name
      CLUSTER_ZONE: asia-south1-a             # GKE Cluster Zone
      GAR_LOCATION: asia-south1               # Artifact Registry region
      REPO_NAME: gcr-gke-poc-repo             # Artifact Registry repository name
      IMAGE_NAME: hello-world                 # Image name in Artifact Registry

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Commit SHA
        run: echo "COMMIT_SHA=$(git rev-parse --short=7 HEAD)" >> $GITHUB_ENV

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Install GKE gcloud auth plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: Build Docker Image
        run: |
          docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest \
                       -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ env.COMMIT_SHA }} .

      - name: Push Docker Image
        run: |
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ env.COMMIT_SHA }}

      - name: Get GKE Credentials
        run: gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} --zone ${{ env.CLUSTER_ZONE }}

      - name: Apply Kubernetes Manifests
        run: kubectl apply -f k8s/

      - name: Restart Deployment to Pull Latest Image
        run: kubectl rollout restart deployment/hello-world

      - name: Wait for Rollout
        run: kubectl rollout status deployment/hello-world
